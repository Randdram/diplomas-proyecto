<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>🛠️ Panel de Administración</title>
  <link rel="stylesheet" href="/static/styles.css" />
</head>
<body>
  <div class="background-animation"></div>
  
  <nav class="nav">
    <div class="wrap">
      <div class="brand">
        <div class="logo">🛠️</div>
        <div class="title">Panel Admin</div>
      </div>
      <div class="links">
        <a href="/" class="muted">👤 Portal Alumnos</a>
        <a href="/admin-logout" class="muted">🚪 Cerrar Sesión</a>
      </div>
    </div>
  </nav>

  <main class="wrap">
    <section class="hero">
      <h1>Panel de Administración</h1>
      <p>Sistema completo de gestión de diplomas</p>
    </section>

    <!-- Herramientas de administración -->
    <section class="card">
      <h3>🛠️ Herramientas del Sistema</h3>
      
      <div class="tools-grid">
        <div class="tool-card">
          <div class="tool-icon">📄</div>
          <h4>Generar Diplomas</h4>
          <p class="muted">Ejecuta el script local para crear PDFs</p>
          <a class="btn admin-action" href="/admin/generar">Instrucciones</a>
        </div>
        
        <div class="tool-card">
          <div class="tool-icon">📊</div>
          <h4>Auditoría</h4>
          <p class="muted">Verifica la consistencia de los registros</p>
          <a class="btn admin-action" href="/admin/auditar">Auditar</a>
        </div>
        
        <div class="tool-card">
          <div class="tool-icon">🔄</div>
          <h4>Sincronización Manual</h4>
          <p class="muted">Asigna URLs de Supabase a registros antiguos</p>
          <a class="btn admin-action" href="/admin/sync">Sincronizar</a>
        </div>
      </div>
    </section>

    <!-- Información del sistema -->
    <section class="card" style="background: rgba(255,255,255,0.05);">
      <h3>📈 Estado del Sistema</h3>
      <div class="stats-grid">
        <div class="stat-item">
          <span class="stat-number">{{ total_alumnos or '0' }}</span>
          <span class="stat-label">Alumnos Registrados</span>
        </div>
        <div class="stat-item">
          <span class="stat-number">{{ total_diplomas or '0' }}</span>
          <span class="stat-label">Diplomas Generados</span>
        </div>
        <div class="stat-item">
          <span class="stat-number">{{ total_verificaciones or '0' }}</span>
          <span class="stat-label">Verificaciones (Est.)</span>
        </div>
        <div class="stat-item">
          <span class="stat-number">{{ sistema_estado or '–' }}</span>
          <span class="stat-label">Estado del Sistema</span>
        </div>
      </div>
    </section>
  </main>

  <footer>
    <div class="wrap">
      <small>© {{ now or '2025' }} Panel de Administración · Sesión activa para <strong>{{ admin_username }}</strong></small>
    </div>
  </footer>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const urlParams = new URLSearchParams(window.location.search);
      const token = urlParams.get('token');

      if (!token) {
        window.location.href = '/admin-login?error=Token+requerido';
        return;
      }

      const adminActions = document.querySelectorAll('.admin-action');

      adminActions.forEach(actionElement => {
        actionElement.addEventListener('click', async (event) => {
          event.preventDefault();
          const endpoint = actionElement.getAttribute('href');
          if (!endpoint) return;

          // Construimos la URL con el token como query parameter, ya que es el método
          // que tu API está usando actualmente para la autenticación de estos endpoints.
          const urlWithToken = `${endpoint}?token=${token}`;

          document.body.innerHTML = `<div class="wrap"><div class="card" style="text-align:center; margin-top: 5rem;"><h1>Procesando...</h1><p>Por favor, espera un momento.</p></div></div>`;

          try {
            const response = await fetch(urlWithToken, {
              method: 'GET'
            });
            
            const htmlResult = await response.text();

            if (response.ok) {
              document.open();
              document.write(htmlResult);
              document.close();
            } else {
              // Si la respuesta no es OK, intentamos mostrar un mensaje de error.
              // FastAPI a menudo redirige en caso de error, lo que el navegador manejará.
              document.body.innerHTML = htmlResult;
            }
          } catch (error) {
            console.error('Error en la petición fetch:', error);
            document.body.innerHTML = `<div class="wrap"><div class="card" style="text-align:center; margin-top: 5rem;"><h1>Error de Red</h1><p>No se pudo conectar con el servidor.</p></div></div>`;
          }
        });
      });
    });
  </script>
</body>
</html>

